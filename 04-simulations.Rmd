# 数值模拟 {#simulations}

空间广义线性混合效应模型在广义线性混合效应模型基础上添加了与空间位置相关的随机效应，这种随机效应在文献中常称为空间效应 [@Diggle1998]。 它与采样点的位置、数量都有关系， 其中采样点的位置决定空间过程的协方差结构， 而采样点的数量决定空间效应的维度，从而导致空间广义线性混合效应模型比普通的广义线性混合效应模型复杂。作为过渡，我们在第 \@ref(sim-one-gp) 和 \@ref(sim-two-gp) 节模拟了一维和二维平稳高斯过程。 第 \@ref(sim-sglmm) 节模拟 SGLMM 模型， 分两个小节展开叙述，第 \@ref(binomal-sglmm) 小节模拟响应变量服从二项分布的情形，  第 \@ref(possion-sglmm) 小节模拟响应变量服从泊松分布的情形，在这两个小节里， 比较了蒙特卡罗极大似然算法，低秩近似算法，贝叶斯马尔科夫链蒙特卡罗算法和贝叶斯 STAN-MCMC 算法的性能差异。

模拟空间广义线性混合效应模型 \@ref(eq:sim-sglmm) 分三节进行，第一节模拟空间高斯过程 $S(x)$，第二节模拟响应变量 $Y$ 服从二项分布 ，第三节模拟响应变量 $Y$ 服从正态分布。空间高斯过程在模型 \@ref(eq:sim-sglmm) 中作为随机效应存在，不同于一般随机效应的地方在于它与样本的空间位置有关，一般地，假定 $S(x)$ 服从 $N$ 元高斯分布 $N(\mu_{S},G)$，$x = (d_1,d_2) \in \mathbb{R}^2$， $\mu_{S} = \mathbf{0}_{N\times1}$， $G_{(ij)} = \mathrm{Cov}(S(x_i),S(x_j))=\sigma^2*\rho(u_{ij})$， $S(x)$ 的相关函数 $\rho(u_{ij}) = \exp(-u_{ij}/\phi), u_{ij} \equiv \|x_{i}-x_{j}\|_2$，其中 $\phi$ 和 $\sigma^2$ 都是未知待估参数。可见采样点的位置 $(d_1,d_2)$ 和相关函数 $\rho(u)$ 一起决定空间高斯过程的形式，并且 $S(x)$ 的维度就是采样点的数目 $N$。这样通常导致空间效应的维度比协变量的数目大很多，模型 \@ref(eq:sim-sglmm) 的估计问题也比一般的广义线性混合效应模型困难。

\begin{equation}
g(\mu_i) = d(x_i)'\beta + S(x_i) + Z_i (\#eq:sim-sglmm)
\end{equation}

## 平稳空间高斯过程 {#spatial-gaussian-processes}

### 一维平稳空间高斯过程 {#sim-one-gp}

如何模拟高斯过程，数学表达式

一维情形下，平稳高斯过程 $S(x)$ 的图像如图 \@ref(fig:one-dim-gp)， 协方差函数采用二次幂指数形式，且额外添加一个非空间成分，见 \@ref(eq:cov-exp-quad)

\begin{align}
\mathsf{Cov}(S(x_i), S(x_j)) & = \sigma^2 \exp\big\{ -\big( \frac{ |x_{i} - x_{j}| }{ \phi } \big) ^ {\kappa} \big\}  (\#eq:cov-exp-quad) \\
\mathsf{Cov}(S(x_i), S(x_j)) & = \sigma^2 \exp\big\{ - \frac{|x_{i} - x_{j}|}{ \phi } \big\}  (\#eq:cov-exp)
\end{align}

```{r sim-one-gp, eval=FALSE, echo=FALSE}
# 指数型协方差函数
sim_one_gp_model_exp <- stan_model("code/sim_one_gp_exp.stan")
# 幂二次指数型协方差函数
sim_one_gp_model_exp_quad <- stan_model("code/sim_one_gp_exp_quad.stan")

dat_list <- list(N = 2000, sigma = 1, phi = 0.15)
set <- sample(1:dat_list$N, size = 36, replace = F) # 部分数据集

draw <- sampling(sim_one_gp_model_exp,
  iter = 1, algorithm = "Fixed_param",
  chains = 1, data = dat_list,
  seed = 363360090
)

draw <- sampling(sim_one_gp_model_exp_quad,
  iter = 1, algorithm = "Fixed_param",
  chains = 1, data = dat_list,
  seed = 363360090
)

samps <- rstan::extract(draw)
plt_df <- with(samps, data.frame(x = x[1, ], f = f[1, ]))
```
```{r one-dim-gp,fig.cap='(ref:one-dim-gp)',fig.ncol=1,fig.sep="\\\\",fig.subcap=c("指数型协方差函数","幂二次指数型协方差函数")}
# 指数型协方差函数  连续但是在原点不可微
# pdf(file = "one-dim-gp-exp.pdf", width = 8, height = 8 * 0.618)
# par(mar = c(4.1, 4.1, 1.5, 0.5))
# plot(f ~ x, data = plt_df, xlab = "x", ylab = "S(x)",pch = 16,col  = "Darkgrey")
# points(f~x,data = plt_df[set,], pch = 16, col = 'darkorange')
# dev.off()
# 幂二次指数型协方差函数 不但连续而且无穷可微
# pdf(file = "one-dim-gp-exp-quad.pdf", width = 8, height = 8 * 0.618)
# par(mar = c(4.1, 4.1, 1.5, 0.5))
# plot(f ~ x, data = plt_df, xlab = "x", ylab = "S(x)",pch = 16,col  = "Darkgrey")
# points(f~x,data = plt_df[set,], pch = 16, col = 'darkorange')
# dev.off()

knitr::include_graphics(path = c(
  "figures/one-dim-gp-exp.png",
  "figures/one-dim-gp-exp-quad.png"
))
```

(ref:one-dim-gp) 模拟一维平稳空间高斯过程，协方差函数为指数型，见公式 \@ref(eq:cov-exp-quad)，均值为 $\mathbf{0}$，参数 $\sigma^1 = 1$，$\phi = 0.15$，$\kappa=2$，横坐标表示采样的位置，纵坐标是目标值 $S(x)$，图中生成 2000 个点。

### 二维平稳空间高斯过程 {#sim-two-gp}

二维情形下，在规则平面上模拟平稳高斯过程 $\mathcal{S} = S(x), x \in \mathbb{R}^2$， 其均值为 $\mathbf{0}$， 自协方差函数为方程 \@ref(eq:cov-exp-quad)，其参数 $\kappa = 2,\phi=1,\sigma^2=1$，单位平面区域为 $[0,1]\times[0,1]$， 将此区域划分为 $6\times 6$ 的小网格，每个格点为采样的位置。由自协方差函数 \@ref(eq:cov-exp-quad) 可以获得 $\mathcal{S}$ 的协方差矩阵，然后使用 R 包 **MASS** 提供的 `mvrnorm` 函数产生多元正态分布随机数。 模拟数据生成的图像见图 \@ref(fig:sim-two-gp)， 格点上的值即为平稳空间高斯过程在该点的取值 （为方便显示，已四舍五入保留两位小数）。

```{r sim-two-gp,fig.cap="模拟二维平稳空间高斯过程，自相关函数为幂指数形式，水平方向为横坐标，垂直方向为纵坐标，图中的格点是目标值 $S(x)$", small.mar=TRUE,fig.asp=1,out.width="55%",fig.width=4.5}
set.seed(2018)
N <- 36
lscale <- 1
sdgp <- 1
## 单位区域上采样
d <- expand.grid(
  d1 = seq(0, 1, l = sqrt(N)),
  d2 = seq(0, 1, l = sqrt(N))
)
D <- as.matrix(dist(d)) # 计算采样点之间的欧氏距离
phi <- 2 * lscale^2
m <- sdgp^2 * exp(-D^2 / phi) # 多元高斯分布的协方差矩阵  二次幂指数核函数
# powered.exponential (or stable)
# rho(h) = exp[-(h/phi)^kappa] if 0 < kappa <= 2 此处 kappa 固定为 2
S <- MASS::mvrnorm(1, rep(0, N), m) # 产生服从多元高斯分布的随机数
plot(c(-0.1, 1.1), c(-0.1, 1.1),
  type = "n",
  panel.first = grid(lwd = 1.5, lty = 2, col = "lightgray"),
  xlab = "Horizontal Coord", ylab = "Vertical Coord"
)
# text(y = d$d1, x = d$d2, labels = round(S, digits = 2), xpd = TRUE)

text(
  y = d$d1, x = d$d2,
  labels = formatC(round(S, digits = 2), format = "f", 
                   digits = 2, drop0trailing = FALSE), 
  xpd = TRUE
)
```
```{r,eval=FALSE,include=FALSE}
# nugget = tau^2 # nugget effect
# cov.pars = c(sigma^2,phi) # partial sill and range parameter
library(geoR)
sim <- grf(36,
  grid = "reg", method = "cholesky",
  cov.pars = c(1, sqrt(2)), nugget = 1, mean = 0,
  cov.model = "powered.exponential", kappa = 2
)
# a display of simulated locations and values
plot(sim$coords, type = "n")
text(sim$coords[, 1], sim$coords[, 2], format(sim$data, digits = 1), cex = 1.5)
```

紧接上文，模拟模型当中的空间效应 $S(x)$ ， 其相关函数可以为指数型或者梅隆型，函数形式如公式 \@ref(eq:exp-matern) 所示。

\begin{equation}
\rho(u) =
\begin{cases}
\exp(-(u/\phi)^{\kappa}) & \text{指数型}\\
\{2^{\kappa -1}\Gamma(\kappa)\}^{-1}(u/\phi)^{\kappa}\mathcal{K}_{\kappa}(u/\phi) & \text{梅隆型}
\end{cases} (\#eq:exp-matern)
\end{equation}

\noindent 固定样本量 $n=1600$ ，其它参数为 $\sigma^2=1,\phi=25,\kappa=1$ ，在区域 $[-0.2,1.2]\times [-0.2,1.2]$ 上，分别模拟规则网格上的采样和 随机采样，图中 $S(x)$ 的值越大，颜色越红，反之，颜色越蓝。使用 R 函数 `dist` 计算样本点之间的距离，用 `MASS::mvrnorm` 函数生成服从多元高斯分布的随机数。

## 空间广义线性混合效应模型 {#sim-sglmm}

模拟的空间广义线性混合效应模型是

\begin{equation}
g(\mu_i) = \beta_{0} + \beta_{1} * X_{1} + \beta_{2} * X_{2} + S(x) (\#eq:sim-SGLMM)
\end{equation}

\noindent 其中，$\beta_0$ 是截距，$\beta_{1},\beta_{2}$ 是固定效应 $X_{1}$ 和 $X_{2}$ 的系数，$S(x)$ 是平稳空间高斯过程，其均值为0，自协方差函数为 $\mathrm{Cov}(S(x_i),S(x_j)) = \sigma^2 \big\{2^{\kappa-1}\Gamma(\kappa)\big\}^{-1}(u/\phi)^{\kappa}K_{\kappa}(u/\phi)$，在后续的模拟中 $\kappa = 2$，$g$ 是联系函数，由响应变量 $Y$ 服从的分布决定，在第 \@ref(binomal-sglmm) 小节中，$g(\mu_i) = \log\{\frac{p(x_i)}{1-p(x_i)}\}$，$Y_{i} \sim \mathrm{Binomal}(m_{i},p(x_{i}))$，在位置 $x_i$ 处，以概率 $p(x_i)$ 重复抽取了 $m_i$ 个样本，总样本数 $M=\sum_{i=1}^{N}m_i$，$N$ 是采样点的个数，在第 \@ref(possion-sglmm) 小节中，$Y_i \sim \mathrm{Possion}(\lambda(x_{i}))$，类似地，$g(\mu_i) = \log\{\lambda(x_{i})\}$。

### 响应变量服从二项分布 {#binomal-sglmm}

响应变量服从二项分布，模型为 \@ref(eq:sim-SGLMM)， 固定效应参数 $\beta = (\beta_0,\beta_1,\beta_2)$， 空间效应参数 $\boldsymbol{\theta} = (\sigma^2,\phi)$。 参数设置为 $\beta = c(-1,1,0.5), \boldsymbol{\theta} = (1,1)$，采样点数目为 $N=49$， 每个采样点抽取的样本数 $m_i = 100,i = 1,2,\ldots,N$，在这组参数下，重复产生 100 个数据集。 分别使用低秩近似算法(LR)， 蒙特卡罗最大似然算法 (MCML)， 贝叶斯 MCMC 算法 (MCMC) 和贝叶斯 STAN-MCMC 算法 (STAN-MCMC) 估计模型的参数。




### 响应变量服从泊松分布 {#possion-sglmm}

响应变量服从泊松分布，模型为 \@ref(eq:sim-SGLMM)，固定效应参数 $\beta = (\beta_0, \beta_1, \beta_2)$， 空间效应参数 $\boldsymbol{\theta} = (\sigma^2,\phi)$。 参数设置为 $\beta = c(-1,1,0.5), \boldsymbol{\theta} = (1,1)$， 采样点数目为 $N=49$， 每个采样点抽取的样本数 $m_i = 100,i = 1,2,\ldots,N$，在这组参数下，重复产生 100 个数据集。


模拟结果如表 \@ref(tab:kable) 所示

```{r kable}
library(purrr)
library(kableExtra)
db <- mtcars[, 1:7]
db2 <- cbind(rownames(db), db)
colnames(db2) <- c("Methods", rep(c("Bias", "RMSE"), 3), "")
if (knitr::is_latex_output()) {
  kable(db2,
    format = "latex", booktabs = TRUE, escape = T, row.names = F,
    longtable = FALSE, caption = "第1种类型的统计表格样式",
    linesep = c("", "", "", "", "", "\\midrule")
  ) %>%
    kable_styling(
      latex_options = c("hold_position", "repeat_header"),
      full_width = F, position = "center", repeat_header_method = "replace",
      repeat_header_text = "续表@ref(tab:kable)"
    ) %>%
    add_header_above(c(" ",
      "$\\\\sigma^2$" = 2, "$\\\\phi$" = 2,
      "$\\\\tau^2$" = 2, "$r=\\\\delta/\\\\phi$" = 1
    ), escape = F) %>%
    footnote(
      general_title = "注：", title_format = "italic", threeparttable = T,
      general = "* 星号表示的内容很长"
    )
} else {
  kable(db2,
    format = "html", booktabs = TRUE, escape = T, row.names = F,
    caption = "第1种类型的统计表格样式"
  ) %>%
    kable_styling(
      bootstrap_options = c("basic"),
      full_width = F, position = "center"
    ) %>%
    add_header_above(c("",
      "$\\sigma^2$" = 2, "$\\phi$" = 2,
      "$\\tau^2$" = 2, "$r=\\delta/\\phi$" = 1
    ), escape = F) %>%
    footnote(
      general_title = "注：", title_format = "italic", threeparttable = T,
      general = "* 星号表示的内容很长"
    )
}
```
